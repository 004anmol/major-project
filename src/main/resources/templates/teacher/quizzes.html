<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout('Quizzes', ~{::content})}">

<body>
<div th:fragment="content">

    <h2 class="mb-4"><i class="fas fa-question-circle"></i> Quizzes</h2>

    <a th:href="@{/teacher/quiz/create}" class="btn btn-primary mb-3">
        <i class="fas fa-plus-circle"></i> Create Quiz
    </a>

    <div class="table-responsive" th:if="${quizzes != null and !quizzes.isEmpty()}">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Student</th>
                <th>Time Limit</th>
                <th>Type</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="quiz : ${quizzes}">
                <td>
                    <strong th:text="${quiz.title}"></strong>
                </td>
                <td th:text="${quiz.description}"></td>
                <td>
                    <span th:if="${quiz.student != null}"
                          th:text="${quiz.student.user.fullName}"></span>
                    <span th:if="${quiz.student == null}"
                          class="text-muted">Not assigned</span>
                </td>
                <td>
                    <span th:if="${quiz.timeLimit != null}">
                        <i class="fas fa-clock text-primary"></i>
                        <span th:text="${quiz.timeLimit} + ' min'"></span>
                    </span>
                    <span th:if="${quiz.timeLimit == null}" class="text-muted">
                        No limit
                    </span>
                </td>
                <td>
                    <span th:if="${quiz.isAiGenerated}" class="badge bg-info">
                        <i class="fas fa-robot"></i> AI Generated
                    </span>
                    <span th:unless="${quiz.isAiGenerated}" class="badge bg-secondary">
                        <i class="fas fa-user"></i> Manual
                    </span>
                </td>
                <td th:text="${#temporals.format(quiz.createdAt, 'dd MMM yyyy HH:mm')}"></td>
                <td>
                    <button class="btn btn-sm btn-info"
                            data-bs-toggle="modal"
                            th:data-bs-target="'#quizModal' + ${quiz.id}">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
            </tbody>

        </table>
    </div>

    <div th:if="${quizzes == null or quizzes.isEmpty()}" class="alert alert-info">
        <i class="fas fa-info-circle"></i> No quizzes created yet. Click "Create Quiz" to get started.
    </div>

    <!-- Quiz Details Modals -->
    <div th:each="quiz : ${quizzes}">
        <div class="modal fade" th:id="'quizModal' + ${quiz.id}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" th:text="${quiz.title}"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Description:</strong> <span th:text="${quiz.description}"></span></p>
                        <p><strong>Student:</strong>
                            <span th:if="${quiz.student != null}"
                                  th:text="${quiz.student.user.fullName}"></span>
                            <span th:if="${quiz.student == null}"
                                  class="text-muted">Not assigned</span>
                        </p>
                        <p><strong>Time Limit:</strong>
                            <span th:if="${quiz.timeLimit != null}"
                                  th:text="${quiz.timeLimit} + ' minutes'"></span>
                            <span th:if="${quiz.timeLimit == null}"
                                  class="text-muted">No time limit</span>
                        </p>
                        <p><strong>Type:</strong>
                            <span th:if="${quiz.isAiGenerated}" class="badge bg-info">AI Generated</span>
                            <span th:unless="${quiz.isAiGenerated}" class="badge bg-secondary">Manual</span>
                        </p>
                        <p><strong>Created:</strong>
                            <span th:text="${#temporals.format(quiz.createdAt, 'dd MMM yyyy HH:mm')}"></span>
                        </p>

                        <hr>

                        <h6 class="mt-3"><strong>Questions Preview:</strong></h6>
                        <div class="quiz-preview" style="max-height: 300px; overflow-y: auto;">
                            <pre class="bg-light p-3 rounded" th:text="${quiz.questions}"></pre>
                        </div>

                        <!-- Show results if available -->
                        <div th:if="${quiz.results != null and !quiz.results.isEmpty()}" class="mt-3">
                            <hr>
                            <h6><strong>Student Results:</strong></h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th>Completed At</th>
                                        <th>Score</th>
                                        <th>Percentage</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="result : ${quiz.results}">
                                        <td th:text="${#temporals.format(result.completedAt, 'dd MMM yyyy HH:mm')}"></td>
                                        <td th:text="${result.score} + '/' + ${result.totalQuestions}"></td>
                                        <td>
                                                <span class="badge"
                                                      th:classappend="${(result.score * 100 / result.totalQuestions) >= 70} ? 'bg-success' : 'bg-warning'">
                                                    <span th:text="${#numbers.formatDecimal(result.score * 100 / result.totalQuestions, 1, 1)} + '%'"></span>
                                                </span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
</body>
</html>